<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarcoExpres Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #status { font-weight: bold; }
        .online { color: green; }
        .offline { color: red; }
        body { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div id="login-screen" class="container mt-5">
        <div class="card shadow-lg p-4">
            <h3 class="text-center">BarcoExpres - Acceso</h3>
            <div class="form-group mb-3">
                <label>Email</label>
                <input type="email" id="email" class="form-control" placeholder="repartidor@barcoexpres.com" value="admin@gmail.com">
            </div>
            <div class="form-group mb-3">
                <label>Contraseña</label>
                <input type="password" id="password" class="form-control" value="12345678">
            </div>
            <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
            <div id="login-error" class="text-danger small mt-2 text-center"></div>
        </div>
    </div>

    <div id="tracker-screen" class="container mt-5 text-center d-none">
        <div class="card shadow">
            <div class="card-body">
                <h2>Rastreo BarcoExpres</h2>
                <hr>
                <div id="status" class="mb-3">Estado: <span class="offline">Inactivo</span></div>
                <div id="coords" class="small text-muted mb-4">
                    Lat: <span id="lat">--</span> | Lng: <span id="lng">--</span>
                </div>
                
                <button id="btnStart" class="btn btn-primary btn-lg w-100 mb-2">Iniciar Viaje</button>
                <button id="btnStop" class="btn btn-danger btn-lg w-100 mb-3" disabled>Detener</button>
                
                <button onclick="logout()" class="btn btn-outline-secondary btn-sm w-100">Cerrar Sesión</button>
            </div>
        </div>
    </div>

    <script>
        // --- LÓGICA DE LOGIN ---
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const response = await fetch('https://www.barcoexpres.com/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                    body: JSON.stringify({ email, password, device_name: navigator.userAgent })
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('user_token', data.token);
                    document.getElementById('login-screen').classList.add('d-none');
                    document.getElementById('tracker-screen').classList.remove('d-none');
                } else {
                    errorDiv.innerText = "Credenciales incorrectas.";
                }
            } catch (e) {
                errorDiv.innerText = "Error de conexión con el servidor.";
            }
        }

        async function logout() {
            const token = localStorage.getItem('user_token');
            try {
                await fetch('https://www.barcoexpres.com/api/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });
            } catch (e) { console.log("Logout local."); }

            localStorage.removeItem('user_token');
            location.reload();
        }

        // --- LÓGICA GPS ---
        let watchId = null;
        const gpsOptions = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };

        document.getElementById('btnStart').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = false;
                document.querySelector('#status span').innerText = "Rastreando...";
                document.querySelector('#status span').className = "online";
                
                watchId = navigator.geolocation.watchPosition(sendData, errorGps, gpsOptions);
            }
        });

        async function sendData(position) {
            document.getElementById('lat').innerText = position.coords.latitude.toFixed(6);
            document.getElementById('lng').innerText = position.coords.longitude.toFixed(6);

            const token = localStorage.getItem('user_token');
            const nuevaUbicacion = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                speed: position.coords.speed || 0,
                recorded_at: new Date().toISOString()
            };

            let pendientes = JSON.parse(localStorage.getItem('gps_queue') || "[]");
            pendientes.push(nuevaUbicacion);

            if (navigator.onLine && token && pendientes.length > 0) {
                try {
                    const response = await fetch('https://www.barcoexpres.com/api/data-batch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ positions: pendientes })
                    });

                    if (response.ok) {
                        localStorage.removeItem('gps_queue');
                        console.log("Sincronizado");
                    }
                } catch (e) {
                    localStorage.setItem('gps_queue', JSON.stringify(pendientes));
                }
            } else {
                localStorage.setItem('gps_queue', JSON.stringify(pendientes));
            }
        }
        
        function errorGps(err) { console.warn('Error GPS:', err.message); }

        document.getElementById('btnStop').addEventListener('click', () => {
            if(watchId) navigator.geolocation.clearWatch(watchId);
            location.reload();
        });
    </script>

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "93091eb2-a0b0-44c0-99ff-bedc721195a4",
            });
        });
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
</body>
</html>
