<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarcoExpres Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        #status { font-weight: bold; }
        .online { color: green; }
        .offline { color: red; }
    </style>

    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
        OneSignal.init({
        appId: "TU_APP_ID_AQUI",
        });
        
        // Cuando el usuario se suscribe, enviamos el ID a Laravel
        OneSignal.getUserId(function(userId) {
            if(userId) {
                actualizarPushIdEnServidor(userId);
            }
        });
    });

    async function actualizarPushIdEnServidor(pushId) {
        const token = localStorage.getItem('user_token');
        if(!token) return;

        await fetch('https://www.barcoexpres.com/api/update-push-id', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ onesignal_id: pushId })
        });
    }
    </script>
</head>
<body class="bg-light">
    <div class="container mt-5 text-center">
        <div class="card shadow">
            <div class="card-body">
                <h2>Rastreo BarcoExpres</h2>
                <hr>
                <div id="status" class="mb-3">Estado: <span class="offline">Inactivo</span></div>
                <div id="coords" class="small text-muted mb-4">Lat: -- | Lng: --</div>
                
                <button id="btnStart" class="btn btn-primary btn-lg w-100 mb-2">Iniciar Viaje</button>
                <button id="btnStop" class="btn btn-danger btn-lg w-100" disabled>Detener</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="container mt-5">
        <div class="card shadow-lg p-4">
            <h3 class="text-center">BarcoExpres - Acceso</h3>
            <div class="form-group mb-3">
                <label>Email</label>
                <input type="email" id="email" class="form-control" placeholder="repartidor@barcoexpres.com" value="admin@gmail.com">
            </div>
            <div class="form-group mb-3">
                <label>Contrase√±a</label>
                <input type="password" id="password" class="form-control" value="12345678">
            </div>
            <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
            <div id="login-error" class="text-danger small mt-2 text-center"></div>
        </div>
    </div>

    <script>
        async function login() {
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const response = await fetch('https://www.barcoexpres.com/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                    body: JSON.stringify({ 
                        email: email, 
                        password: password,
                        device_name: navigator.userAgent // Esto identifica el navegador/celular
                    })
                });

                
                // Despu√©s de un login exitoso
                const data = await response.json();
                
                
                if (response.ok) {
                    localStorage.setItem('user_token', data.token); // Guardamos el token
                    document.getElementById('login-screen').classList.add('d-none');
                    document.getElementById('tracker-screen').classList.remove('d-none'); // Mostramos el panel de GPS
                } else {
                    errorDiv.innerText = "Credenciales incorrectas.";
                }
            } catch (e) {
                errorDiv.innerText = "Error de conexi√≥n con el servidor.";
            }
        }

        async function logout() {
            const token = localStorage.getItem('user_token');

            try {
                // 1. Avisar al servidor para eliminar el token
                await fetch('https://www.barcoexpres.com/api/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
            } catch (e) {
                console.log("Error al avisar al servidor, igual cerraremos sesi√≥n localmente.");
            }

            // 2. Limpiar datos locales
            localStorage.removeItem('user_token');
            
            // 3. Regresar a la pantalla de login
            document.getElementById('tracker-screen').classList.add('d-none');
            document.getElementById('login-screen').classList.remove('d-none');
            
            // Opcional: Recargar para limpiar variables de memoria
            location.reload();
        }

    </script>

    <script>
        let watchId = null;
        const userId = 5; // Esto vendr√° del login despu√©s
        
        const gpsOptions = {
            enableHighAccuracy: true, // Intenta usar sat√©lites
            timeout: 15000,           // Espera hasta 15 segundos antes de dar error
            maximumAge: 0             // Fuerza a que la posici√≥n sea nueva, no de cach√©
        };

        document.getElementById('btnStart').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                // ... (tu c√≥digo de botones) ...
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = false;
                document.querySelector('#status span').innerText = "Rastreando...";
                document.querySelector('#status span').className = "online";
                
                watchId = navigator.geolocation.watchPosition(sendData, (error) => {
                    if (error.code === 2) {
                        console.log("Reintentando... el sensor est√° tardando en responder.");
                        // No detenemos el proceso, dejamos que siga intentando
                    } else {
                        errorGps(error);
                    }
                }, gpsOptions);
            }
        });

        // document.getElementById('btnStart').addEventListener('click', () => {
        //     if ("geolocation" in navigator) {
        //         document.getElementById('btnStart').disabled = true;
        //         document.getElementById('btnStop').disabled = false;
        //         document.querySelector('#status span').innerText = "Rastreando...";
        //         document.querySelector('#status span').className = "online";

        //         // WatchPosition actualiza cada vez que el GPS detecta movimiento
        //         watchId = navigator.geolocation.watchPosition(sendData, errorGps, {
        //             enableHighAccuracy: false, // Menos preciso pero m√°s r√°pido si est√°s bajo techo
        //             timeout: 10000,            // Esperar m√°ximo 10 segundos
        //             maximumAge: 0              // No usar ubicaciones viejas de cach√©
        //         });
        //     }
        // });

        async function sendData(position) {
            
            document.getElementById('lat').innerText = position.coords.latitude.toFixed(6);
            document.getElementById('lng').innerText = position.coords.longitude.toFixed(6);

            const token = localStorage.getItem('user_token');
            
            // 1. CREAMOS el objeto con la ubicaci√≥n actual
            const nuevaUbicacion = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                speed: position.coords.speed || 0,
                recorded_at: new Date().toISOString()
            };

            // 2. OBTENEMOS la cola existente y a√±adimos la nueva ubicaci√≥n
            let pendientes = JSON.parse(localStorage.getItem('gps_queue') || "[]");
            pendientes.push(nuevaUbicacion);

            // 3. VALIDAMOS si hay algo que enviar y si hay internet
            if (pendientes.length === 0) return;

            if (navigator.onLine && token) {
                try {
                    console.log("Intentando sincronizar " + pendientes.length + " puntos...");
                    
                    const response = await fetch('https://www.barcoexpres.com/api/data-batch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ positions: pendientes })
                    });

                    if (response.ok) {
                        // Si el servidor responde 200 OK, borramos la cola
                        localStorage.removeItem('gps_queue');
                        console.log("‚úÖ Sincronizaci√≥n exitosa.");
                    } else {
                        // Si el servidor da error (ej. 500), mantenemos los datos para reintentar
                        console.error("‚ùå Error en el servidor, guardando puntos para reintento.");
                        localStorage.setItem('gps_queue', JSON.stringify(pendientes));
                    }
                } catch (e) {
                    // Si falla la conexi√≥n (p√©rdida de se√±al), guardamos
                    console.warn("üì° Sin conexi√≥n. Puntos acumulados: " + pendientes.length);
                    localStorage.setItem('gps_queue', JSON.stringify(pendientes));
                }
            } else {
                // Si no hay internet o no ha iniciado sesi√≥n, solo acumulamos
                localStorage.setItem('gps_queue', JSON.stringify(pendientes));
            }
        }
        
        function errorGps(err) { console.warn('ERROR(' + err.code + '): ' + err.message); }

        document.getElementById('btnStop').addEventListener('click', () => {
            navigator.geolocation.clearWatch(watchId);
            location.reload(); // Reinicia la app
        });
    </script>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
            OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "93091eb2-a0b0-44c0-99ff-bedc721195a4",
            });
        });
    </script>
</body>
</html>